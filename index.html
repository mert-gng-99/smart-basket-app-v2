<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sepet & Bütçe Mini App</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1110" />
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <!-- Favicons (opsiyonel) -->
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png" />

  <style>
    /* =========================================================
       MARKET THEME • i18n • Micro‑interactions & Animations
       ========================================================= */
    :root{
      /* Market vibe palette (fresh green + citrus highlight) */
      --bg:#0b1110;          /* page background */
      --bg2:#0a120e;         /* gradient mix */
      --card:#0f1713;        /* card base */
      --text:#e6f3ea;        /* primary text */
      --muted:#93a59a;       /* secondary text */
      --accent:#22c55e;      /* primary (green) */
      --accent-2:#f59e0b;    /* highlight (orange) */
      --danger:#ef4444;      /* destructive */
      --border:#1a2a22;      /* subtle borders */
      --ring:#22c55e33;      /* focus ring */

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
    html{height:100%; background:var(--bg); color-scheme: dark; overscroll-behavior-y:none}
    body{
      min-height:100dvh; margin:0; color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      background:
        radial-gradient(1200px 600px at 80% -10%, #174a3170 0%, transparent 60%),
        radial-gradient(800px 500px at -10% 20%, #50320e50 0%, transparent 55%),
        linear-gradient(180deg, var(--bg2) 0%, var(--bg) 40%);
      background-attachment:fixed;
      display:flex; flex-direction:column; gap:16px; overflow-x:hidden;
    }
    ::selection{background:#22c55e55}

    /* ===== Layout ===== */
    header{
      position:sticky; top:0; z-index:3;
      backdrop-filter:saturate(120%) blur(8px);
      background:color-mix(in oklab, #0a130f 70%, transparent);
      border-bottom:1px solid var(--border);
      padding-top:calc(8px + var(--safe-top));
    }
    .wrap{max-width:880px; margin:0 auto; padding:18px 20px}

    .topbar{display:flex; align-items:center; gap:12px; justify-content:space-between}
    .title{display:flex; align-items:center; gap:12px; margin:0}
    .title svg{width:26px; height:26px; filter:drop-shadow(0 2px 8px #22c55e55)}
    .muted{color:var(--muted); font-size:14px}

    .card{
      background:color-mix(in oklab, var(--card) 90%, #09140e);
      border:1px solid var(--border);
      border-radius:16px; padding:14px;
      box-shadow:0 10px 30px #00000040, inset 0 1px 0 #ffffff08;
      animation:card-in .45s cubic-bezier(.2,.7,.2,1);
    }
    @keyframes card-in{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    /* ===== Inputs ===== */
    .input-row{display:grid; grid-template-columns:1.2fr .6fr auto; gap:10px; align-items:end}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    input[type="text"], input[type="number"], input[type="search"], select{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:#0b1510; color:var(--text); outline:none;
      transition:border-color .18s ease, box-shadow .18s ease, transform .06s ease;
    }
    input:focus{border-color:#1f7c46; box-shadow:0 0 0 6px var(--ring); transform:translateY(-1px)}
    input::placeholder{color:#7ea08b}
    select:focus{border-color:#1f7c46; box-shadow:0 0 0 6px var(--ring); transform:translateY(-1px)}
    .market-row{display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px}
    .market-control{flex:1; min-width:200px}
    .market-status{font-size:12px; min-height:18px; padding-bottom:4px}
    .market-actions{display:flex; gap:8px; align-items:center}
    .btn-sm{padding:8px 10px; font-size:14px; border-radius:10px}
    .market-add{margin-bottom:12px; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#0b1510}
    .market-add-row{display:flex; gap:8px; flex-wrap:wrap}
    .market-add-row input{flex:1 1 220px}
    .market-feedback{font-size:12px; margin-top:8px; min-height:16px}
    .market-custom-wrap{margin-bottom:12px}
    .market-custom-title{font-size:12px; margin-bottom:6px}
    .market-tags{display:flex; flex-wrap:wrap; gap:8px}
    .market-tag{display:inline-flex; align-items:center; gap:6px; border:1px solid #1b2a22; border-radius:999px; padding:6px 10px; background:#101b16; font-size:13px}
    .market-tag button{border:none; background:transparent; color:var(--muted); cursor:pointer; font-size:15px; line-height:1}
    .market-tag button:hover{color:var(--danger)}
    .market-products-card{margin-top:24px}
    .market-products-header{display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap}
    .market-products-header h2{margin:0; font-size:18px}
    .market-products-header p{margin:0; font-size:13px}
    .market-products-search{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0}
    .market-products-search input{flex:1 1 220px; z-index: 1;}
    .market-products-search .btn-sm{flex-shrink: 0;}
    .market-products-list{display:flex; flex-direction:column; gap:12px}
    .market-product-item{display:flex; justify-content:space-between; gap:14px; border:1px solid var(--border); border-radius:12px; padding:12px; background:#0b1510; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease-in-out;}
    .market-product-item:hover{transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15);}
    .market-product-info{display:flex; flex-direction:column; gap:6px; flex:1}
    .market-product-title{font-weight:600; font-size: 17px;}
    .market-product-meta{font-size:13px; color:var(--muted)}
    .market-product-actions{display:flex; align-items:center; gap:12px; flex-shrink:0}
    .market-product-price{font-weight:700; color:var(--accent); font-size:16px}
    .market-products-card .btn-sm{white-space:nowrap}
    @media (max-width:640px){
      .input-row{grid-template-columns:1fr; align-items:stretch}
      .market-row{flex-direction:column; align-items:stretch}
      .market-actions{justify-content:flex-start}
      .market-add-row{flex-direction:column}
      .market-add-row input{flex:1 1 auto; width:100%}
      .market-products-header{flex-direction:column; align-items:flex-start}
      .market-products-search{flex-direction:column; align-items:stretch}
      .market-products-search .btn-sm{width:100%}
      .market-product-item{flex-direction:column; align-items:flex-start}
      .market-product-actions{width:100%; justify-content:space-between}
      .btn-sm{width:100%; text-align:center}
    }
    #productSection .btn-sm {
        white-space: nowrap;
    }
    @media (max-width: 640px) {
        #productSection .market-products-search .btn-sm {
            width: 100%;
        }
    }
    .suggestions{margin-top:12px; border:1px solid var(--border); border-radius:12px; background:#0b1510; padding:12px; box-shadow:0 12px 30px #00000029; display:flex; flex-direction:column; gap:8px}
    .suggestions[hidden]{display:none}
    .suggestion-message{font-size:12px}
    .suggestion-list{display:flex; flex-direction:column; gap:8px; max-height:220px; overflow-y:auto}
    .suggestion-item{display:flex; flex-direction:column; align-items:flex-start; gap:4px; padding:10px 12px; border-radius:10px; border:1px solid #1b2a22; background:linear-gradient(180deg,#101b16,#0d1612); color:inherit; cursor:pointer; transition:border-color .15s ease, background .15s ease}
    .suggestion-item:hover{border-color:#1f8a4a; background:linear-gradient(180deg,#122219,#0f1914)}
    .suggestion-item:active{transform:scale(.98)}
    .suggestion-item strong{font-weight:600}
    .suggestion-meta{font-size:12px; color:var(--muted)}

    /* ===== Buttons (micro‑interactions) ===== */
    button{position:relative; overflow:hidden}
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:12px 14px;
      border-radius:12px; border:1px solid #1b2a22; cursor:pointer;
      font-weight:700; color:#e7ffef; background:linear-gradient(180deg,#102019,#0c1712);
      transition:transform .08s ease, filter .2s ease, border-color .2s ease, box-shadow .2s ease;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .btn svg{width:18px; height:18px}
    .btn:hover{filter:brightness(1.06); border-color:#2a4d3c}
    .btn:active{transform:translateY(1px) scale(.98)}
    .btn-primary{background:linear-gradient(180deg,#1f8a4a,#1a6e3c); border-color:#1f8a4a}
    .btn-primary:hover{box-shadow:0 10px 24px #22c55e33}

    .btn-ghost{
      background:transparent; border:1px solid #294437; color:#d6f5e4;
    }
    .btn-ghost:hover{border-color:#35624d}

    /* ripple for ALL buttons */
    .ripple{position:absolute; inset:auto; width:8px; height:8px; border-radius:999px; opacity:.25; background:currentColor; transform:translate(-50%,-50%) scale(0); pointer-events:none; animation:ripple .6s ease}
    @keyframes ripple{to{transform:translate(-50%,-50%) scale(24); opacity:0}}

    /* fun POP when adding */
    .bump{animation:bump .36s cubic-bezier(.2,.7,.2,1)}
    @keyframes bump{0%{transform:scale(1)} 30%{transform:scale(1.06)} 100%{transform:scale(1)}}

    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .market-products-list {
        animation: fade-in 0.5s ease-in-out;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }

    .market-products-loading {
        animation: pulse 1.5s infinite;
    }

    /* ===== Items ===== */
    .items{display:flex; flex-direction:column; gap:10px; margin-top:12px}
    .item{
      display:grid; grid-template-columns:auto 1fr auto auto auto; gap:10px; align-items:center;
      padding:10px 12px; border:1px dashed #244233; border-radius:12px; background:#0c1712;
      animation:item-in .35s cubic-bezier(.21,.7,.18,1);
    }
    @keyframes item-in{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
    .item.done{opacity:.6; text-decoration:line-through}
    .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #284f3b; color:#c6f1d9; background:#0c1e15}
    .money{font-variant-numeric:tabular-nums; font-weight:700}

    /* ===== Edit Modal ===== */
    .modal{position:fixed; inset:0; z-index:999; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.75); backdrop-filter:blur(4px); animation:modal-in .3s ease}
    .modal.show{display:flex}
    @keyframes modal-in{from{opacity:0} to{opacity:1}}
    .modal-card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; width:90%; max-width:400px; box-shadow:0 20px 60px rgba(0,0,0,.6); animation:modal-up .3s cubic-bezier(.2,.7,.2,1)}
    @keyframes modal-up{from{transform:translateY(20px) scale(.95); opacity:0} to{transform:translateY(0) scale(1); opacity:1}}
    .modal-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    .modal-header h3{margin:0; font-size:18px}
    .modal-actions{display:flex; gap:10px; margin-top:16px}

    /* ===== Footer totals (safe-area aware) ===== */
    footer.totals{
      position:sticky; bottom:0; z-index:3;
      background:color-mix(in oklab, #0a130f 88%, transparent);
      border-top:1px solid var(--border); backdrop-filter:saturate(120%) blur(8px);
      padding-bottom:calc(8px + var(--safe-bottom));
    }
    .totals-row{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .badge{display:inline-flex; align-items:center; gap:6px; background:#0e1c15; border:1px solid #1e3a2d; padding:8px 10px; border-radius:12px; font-weight:600}
    .badge svg{width:16px; height:16px}
    .total{display:flex; align-items:center; gap:12px; font-weight:800; font-size:18px; background:linear-gradient(180deg,#0e1f17,#0b1914); border:1px solid #224035; padding:10px 14px; border-radius:12px; box-shadow:inset 0 1px 0 #ffffff08, 0 6px 20px #00000040}

    /* ===== Toast ===== */
    .toast{position:fixed; right:20px; bottom:calc(88px + var(--safe-bottom)); z-index:9999; display:none; background:#0c1a12; border:1px solid #1c3d2a; color:#dbffe6; padding:12px 14px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .toast.show{display:block; animation:slideup .35s ease}
    @keyframes slideup{from{transform:translateY(12px); opacity:.4} to{transform:translateY(0); opacity:1}}

    /* ===== Language Toggle (top-right flag) ===== */
    .flag-btn{
      --ringC:#22c55e55;
      width:42px; height:42px; border-radius:999px; border:1px solid #1e342a; background:#0d1b14; display:grid; place-items:center; cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.35); position:relative; isolation:isolate;
      transition:transform .08s ease, filter .18s ease, border-color .2s ease;
    }
    .flag-btn:hover{filter:brightness(1.06); border-color:#2b4c3e}
    .flag-btn:active{transform:translateY(1px) scale(.98)}
    .flag-ring{position:absolute; inset:-6px; border-radius:inherit; border:2px solid var(--ringC); opacity:.6; animation:ring-pulse 1.6s ease infinite}
    @keyframes ring-pulse{0%{transform:scale(1); opacity:.6} 70%{transform:scale(1.1); opacity:.1} 100%{transform:scale(1); opacity:.6}}

    /* ===== Mobile tweaks ===== */
    @media (max-width:640px){
      .wrap{padding:16px 14px}
      .input-row{grid-template-columns:1fr 1fr auto}
      .item{grid-template-columns:auto 1fr auto auto}
      .item .pill{display:none}
      .modal-card{width:95%; padding:16px}
    }

    /* Reduce motion preference */
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important}
    }

    /* === Elevated styling === */
    body{font:16px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:radial-gradient(1100px 640px at 80% -10%, rgba(45,170,100,.55) 0%, transparent 60%),radial-gradient(900px 540px at -22% 35%, rgba(160,93,21,.35) 0%, transparent 55%),linear-gradient(180deg, var(--bg2) 0%, var(--bg) 45%);}
    body::before{content:""; position:fixed; inset:-45%; pointer-events:none; background:radial-gradient(circle at center, rgba(255,255,255,.12) 0%, transparent 62%); filter:blur(90px); opacity:.65; animation:floatGlow 24s ease-in-out infinite;}
    .card{border-radius:20px; padding:18px 20px; border:1px solid color-mix(in srgb, var(--accent) 30%, transparent); background:linear-gradient(160deg, rgba(34,197,94,0.08), rgba(11,17,16,0.92)); box-shadow:0 32px 60px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.04); backdrop-filter:blur(26px); transition:transform .45s cubic-bezier(.19,1,.22,1), border-color .45s ease, box-shadow .45s ease;}
    .card:hover{transform:translateY(-6px); border-color:color-mix(in srgb, var(--accent) 60%, transparent); box-shadow:0 40px 90px rgba(21,84,54,0.45);}
    label{text-transform:uppercase; letter-spacing:.08em;}
    .btn{box-shadow:0 16px 34px rgba(22,84,54,0.35); border:1px solid rgba(34,197,94,0.35);}
    .btn:hover{border-color:rgba(34,197,94,0.65); box-shadow:0 26px 44px rgba(22,84,54,0.45);}
    .btn-sm{padding:10px 14px; border-radius:12px;}
    .market-add{border-radius:16px; padding:12px 14px; box-shadow:0 18px 36px rgba(0,0,0,0.28);}
    .market-tag{padding:6px 12px; background:linear-gradient(90deg,#12241b,#0a1611); box-shadow:0 12px 22px rgba(0,0,0,0.22);}
    .market-tag button{font-size:16px; transition:color .18s ease, transform .18s ease;}
    .market-tag button:hover{color:var(--danger); transform:scale(1.16);}
    .market-products-card{position:relative; overflow:hidden;}
    .market-products-card::before{content:""; position:absolute; inset:0; background:linear-gradient(135deg,rgba(34,197,94,.12),transparent); opacity:0; transition:opacity .4s ease;}
    .market-products-card:hover::before{opacity:1;}
    .market-products-header h2{font-size:20px; letter-spacing:-.01em;}
    .market-products-header p{margin:4px 0 0 0;}
    .market-product-item{border:1px solid rgba(34,197,94,0.18); border-radius:16px; padding:16px; box-shadow:0 24px 48px rgba(0,0,0,0.26); animation:fadeInUp .35s ease forwards;}
    .market-product-info{min-width:0;}
    .market-product-title{font-size:16px; letter-spacing:-.01em;}
    .market-product-meta{text-transform:uppercase; letter-spacing:.12em;}
    .market-product-price{font-size:18px; text-shadow:0 0 18px rgba(34,197,94,0.35);}
    .market-products-list .btn-sm{justify-content:center; gap:8px;}
    .market-products-list .btn-sm::after{content:"→"; font-size:14px; transition:transform .18s ease, opacity .18s ease; opacity:.85;}
    .market-products-list .btn-sm:hover::after{transform:translateX(3px);}
    .market-product-item.skeleton{position:relative; overflow:hidden; border-color:#1f2f27; animation:pulse 1.6s ease-in-out infinite;}
    .market-product-item.skeleton::after{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.07) 45%, transparent 100%); transform:translateX(-100%); animation:shimmer 1.5s infinite;}
    header::before{content:""; position:absolute; inset:20px; border-radius:18px; background:radial-gradient(circle at top right, rgba(34,197,94,0.18), transparent 55%); opacity:.7; pointer-events:none;}
    @keyframes floatGlow{0%,100%{transform:translate(-10%, -5%) scale(1);}50%{transform:translate(4%, 6%) scale(1.12);}}
    @keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
    @keyframes pulse{0%,100%{opacity:.55;}50%{opacity:1;}}
    @keyframes fadeInUp{from{opacity:0; transform:translateY(12px);}to{opacity:1; transform:translateY(0);}}
    @media (max-width:900px){.wrap{padding:18px 16px;}}
    @media (max-width:640px){.btn-sm{width:100%; text-align:center; justify-content:center;}}
    @media (prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms !important; animation-iteration-count:1 !important; transition-duration:.01ms !important;}}
    /* === End elevated styling === */

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
    }

    .pagination button {
        margin: 0 5px;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background-color: var(--card);
        color: var(--text);
        cursor: pointer;
    }

    .pagination button.active {
        background-color: var(--accent);
        color: var(--bg);
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <h1 class="title" id="heroTitle">
          <!-- cart icon -->
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6h15l-2 8H8L6 2H2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="9" cy="21" r="1" fill="currentColor"/><circle cx="18" cy="21" r="1" fill="currentColor"/>
          </svg>
          <span id="appName">Smart Basket</span>
          <span class="muted" id="heroSub">• hızlı not al, sepete ekle, toplamı gör</span>
        </h1>
        <button id="langBtn" class="flag-btn" title="Dil / Language">
          <span class="flag-ring" aria-hidden="true"></span>
          <!-- Default: TR flag -->
          <svg id="flagIcon" viewBox="0 0 640 480" width="24" height="24" aria-hidden="true">
            <g fill-rule="evenodd" stroke-width="1pt">
              <path fill="#e30a17" d="M0 0h640v480H0z"/>
              <path fill="#fff" d="M406 240c0 66.274-53.726 120-120 120S166 306.274 166 240s53.726-120 120-120 120 53.726 120 120z"/>
              <path fill="#e30a17" d="M413 240c0 52.467-42.533 95-95 95s-95-42.533-95-95 42.533-95 95-95 95 42.533 95 95z"/>
              <path fill="#fff" d="m421 240-60.78 19.021 37.6-51.733v65.424l-37.6-51.733z"/>
            </g>
          </svg>
        </button>
      </div>

      <div class="card">
        <div class="market-row">
          <div class="market-control">
            <label for="marketSelect" id="labelMarket">Market</label>
            <select id="marketSelect">
              <option value="">Tüm marketler</option>
            </select>
          </div>
          <div class="market-actions">
            <button id="marketAddToggle" class="btn btn-ghost btn-sm" type="button">Yeni market ekle</button>
          </div>
        </div>
        <div id="marketStatus" class="muted market-status" aria-live="polite"></div>
        <div id="marketAddForm" class="market-add" hidden>
          <div class="market-add-row">
            <input id="marketAddName" type="text" autocomplete="off" placeholder="Market adı" />
            <button id="marketAddSave" class="btn btn-primary btn-sm" type="button">Kaydet</button>
            <button id="marketAddCancel" class="btn btn-ghost btn-sm" type="button">İptal</button>
          </div>
          <div id="marketAddFeedback" class="muted market-feedback" aria-live="polite"></div>
        </div>
        <div id="customMarketsWrap" class="market-custom-wrap">
          <div id="customMarketsTitle" class="muted market-custom-title"></div>
          <div id="customMarkets" class="market-tags"></div>
        </div>
        <div class="input-row">
          <div>
            <label for="name" id="labelName">Ürün adı</label>
            <input id="name" type="text" placeholder="Örn: Süt 1L" autocomplete="off" />
          </div>
          <div>
            <label for="price" id="labelPrice">Fiyat (₺)</label>
            <input id="price" type="text" inputmode="decimal" placeholder="Örn: 39,90" />
          </div>
          <div>
            <label style="visibility:hidden">.</label>
            <button id="addBtn" class="btn btn-primary" title="Sepete ekle">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 6h15l-2 8H8L6 2H2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 12l3 3 6-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span id="btnAddText">Sepete Ekle</span>
            </button>
          </div>
        </div>
        <div id="suggestions" class="suggestions" hidden>
          <div id="suggestionMessage" class="muted suggestion-message"></div>
          <div id="suggestionList" class="suggestion-list"></div>
        </div>
        <div class="items" id="items"></div>
      </div>
    </div>
  </header>

  <section class="wrap" id="productSection">
    <div class="card market-products-card" id="marketProductsCard">
      <div class="market-products-header">
        <div>
          <h2 id="marketProductsTitle">Market ürünleri</h2>
          <p class="muted" id="marketProductsSubtitle">Seçtiğin marketten ürün ara.</p>
        </div>
      </div>
      <div class="market-products-search">
        <input id="marketProductsInput" type="search" autocomplete="off" placeholder="Ürün ara" />
        <button id="marketProductsSearch" class="btn btn-primary btn-sm" type="button">Ara</button>
        <button id="marketProductsViewAll" class="btn btn-secondary btn-sm" type="button">Tümünü Görüntüle</button>
        <button id="marketProductsRefresh" class="btn btn-ghost btn-sm" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
            </svg>
            Yenile
        </button>
      </div>
      <div id="marketProductsStatus" class="muted market-feedback" aria-live="polite"></div>
      <div id="marketProductsList" class="market-products-list"></div>
      <div id="pagination" class="pagination"></div>
    </div>
  </section>

  <main class="wrap" id="emptyState" style="display:none;">
    <div class="card" style="text-align:center; padding:30px" id="emptyText">
      Henüz ürün yok. Ürün adını ve fiyatını yazıp <strong>Sepete Ekle</strong>'ye bas.
    </div>
</main>

  <footer class="totals">
    <div class="wrap totals-row">
      <div class="badge">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M8 6h13l-2 8H9L7 2H2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span id="count">0 ürün</span>
      </div>
      <div class="total" id="totalBox">
        <span id="totalLabel">Toplam:</span>
        <span class="money" id="total">₺0,00</span>
        <button class="btn btn-ghost" id="clearAll" title="Hepsini temizle">Temizle</button>
      </div>
    </div>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite">Sepete atıldı</div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="editModalTitle">Ürün Düzenle</h3>
        <button id="editModalClose" class="btn btn-ghost" style="padding:8px" title="Kapat">✕</button>
      </div>
      <div>
        <label for="editName" id="editLabelName">Ürün adı</label>
        <input id="editName" type="text" autocomplete="off" style="margin-bottom:10px" />
      </div>
      <div>
        <label for="editPrice" id="editLabelPrice">Fiyat</label>
        <input id="editPrice" type="text" inputmode="decimal" />
      </div>
      <div class="modal-actions">
        <button id="editSaveBtn" class="btn btn-primary" style="flex:1">Kaydet</button>
        <button id="editCancelBtn" class="btn btn-ghost" style="flex:1">İptal</button>
      </div>
    </div>
  </div>

  <script>
    // ================= i18n =================
    const I18N = {
      tr: {
        appTitle: 'Sepet & Bütçe Mini App',
        appName: 'Smart Basket',
        hero: 'Hızlı not al, sepete ekle, toplamı gör',
        labels: {
          name: 'Ürün adı',
          price: 'Fiyat',
          pricePh: 'Örn: 39,90',
          namePh: 'Örn: Süt 1L',
          market: 'Market',
          marketPh: 'Market seç (opsiyonel)'
        },
        market: {
          loading: 'Market listesi alınıyor...',
          readyAny: count => `${count} marketten fiyat önerileri`,
          readySpecific: name => `${name} fiyatları`,
          failed: 'Market listesi alınamadı. Listeden kendin seçebilirsin.',
          anyOption: 'Tüm marketler',
          addToggle: 'Yeni market ekle',
          addPlaceholder: 'Market adı',
          addSave: 'Kaydet',
          addCancel: 'İptal',
          saved: 'Market kaydedildi.',
          duplicate: 'Bu market zaten listede.',
          removed: 'Market silindi.',
          customTitle: 'Kayıtlı marketler',
          customEmpty: 'Henüz eklenmiş market yok.',
          removeLabel: 'Kaldır'
        },
        suggestions: {
          hint: 'Ürün adını yaz, fiyat önerileri gelsin.',
          searching: 'Fiyatlar aranıyor...',
          empty: 'Bu ürün için fiyat bulunamadı.',
          error: 'Fiyat önerileri şu anda alınamadı.',
          manual: 'Her zaman manuel fiyat girişi yapabilirsin.'
        },
        products: {
          title: 'Market ürünleri',
          subtitle: 'Ürün aramak için bir market seç.',
          subtitleSelected: marketName => `${marketName} marketinden ürün ara.`,
          searchPlaceholder: 'Örn: kıyma, süt, peynir...',
          searchButton: 'Ara',
          refresh: 'Yenile',
          loading: 'Ürünler yükleniyor...',
          emptyMarket: 'Lütfen önce bir market seç.',
          emptyQuery: 'Ürün aramak için bir anahtar kelime yaz.',
          emptyResult: 'Bu market için sonuç bulunamadı.',
          error: 'Ürünler alınırken bir hata oluştu.',
          resultHint: 'Ürünleri sepete eklemek için butona dokun.',
          addButton: 'Sepete ekle',
          added: 'Ürün sepete eklendi.',
          viewAll: 'Tümünü Görüntüle'
        },
        add: 'Sepete Ekle', added: 'Sepete atıldı', tick: 'Satın alındı olarak işaretle', del: 'Sil', edit: 'Düzenle',
        editTitle: 'Ürünü Düzenle', save: 'Kaydet', cancel: 'İptal',
        empty: 'Henüz ürün yok. Ürün adını ve fiyatını yazıp <strong>Sepete Ekle</strong> butonuna bas.',
        count: n => `${n} ürün`, total: 'Toplam:', clear: 'Temizle', confirmClear: 'Tüm ürünler silinsin mi?'
      },
      en: {
        appTitle: 'Cart & Budget Mini App',
        appName: 'Smart Basket',
        hero: 'Jot fast, add to cart, see the total',
        labels: {
          name: 'Product name',
          price: 'Price',
          pricePh: 'e.g., 4.99',
          namePh: 'e.g., Milk 1L',
          market: 'Store',
          marketPh: 'Choose a store (optional)'
        },
        market: {
          loading: 'Loading stores...',
          readyAny: count => `Suggestions from ${count} stores`,
          readySpecific: name => `Prices from ${name}`,
          failed: 'Couldn\'t load store list. Please pick manually.',
          anyOption: 'All stores',
          addToggle: 'Add store',
          addPlaceholder: 'Store name',
          addSave: 'Save',
          addCancel: 'Cancel',
          saved: 'Store saved.',
          duplicate: 'That store is already in the list.',
          removed: 'Store removed.',
          customTitle: 'Saved stores',
          customEmpty: 'No saved stores yet.',
          removeLabel: 'Remove'
        },
        suggestions: {
          hint: 'Start typing a product to see price suggestions.',
          searching: 'Looking up prices...',
          empty: 'No price suggestion for that item.',
          error: 'Couldn\'t fetch price suggestions right now.',
          manual: 'You can always enter the price manually.'
        },
        products: {
          title: 'Store products',
          subtitle: 'Choose a store to browse available products.',
          subtitleSelected: marketName => `Browse items from ${marketName}.`,
          searchPlaceholder: 'e.g. minced meat, milk, cheese…',
          searchButton: 'Search',
          refresh: 'Refresh',
          loading: 'Loading items…',
          emptyMarket: 'Please select a store first.',
          emptyQuery: 'Type a keyword to search.',
          emptyResult: 'No results found for this store.',
          error: 'Couldn\'t load products at the moment.',
          resultHint: 'Tap the button to add products to your basket.',
          addButton: 'Add to cart',
          added: 'Product added to basket.',
          viewAll: 'View All'
        },
        add: 'Add to Cart', added: 'Added to cart', tick: 'Mark as purchased', del: 'Delete', edit: 'Edit',
        editTitle: 'Edit Product', save: 'Save', cancel: 'Cancel',
        empty: 'No items yet. Type a product and a price, then press <strong>Add to Cart</strong>.',
        count: n => `${n} item${n === 1 ? '' : 's'}`, total: 'Total:', clear: 'Clear', confirmClear: 'Delete all items?'
      }
    };

    const CURRENCY = { tr: 'TRY', en: 'USD' };
    const LOCALE   = { tr: 'tr-TR', en: 'en-US' };

    const API = { V1: 'https://api.marketfiyati.org.tr/api/v1', V2: 'https://api.marketfiyati.org.tr/api/v2' };
    const MARKET_LABELS = {
      migros: 'Migros',
      migrosjet: 'Migros Jet',
      carrefour: 'CarrefourSA',
      bim: 'BİM',
      a101: 'A101',
      sok: 'Şok',
      tarim_kredi: 'Tarım Kredi',
      metro: 'Metro',
      happycenter: 'Happy Center',
      hakmar: 'Hakmar',
      file: 'FİLE',
      mopas: 'Mopaş Market'
    };
    const FALLBACK_MARKETS = ['migros','carrefour','a101','bim','sok','tarim_kredi','mopas'];
    const MARKET_STORAGE_KEY = 'smart-basket-custom-markets';

    function currencySymbol(code){
      try{
        const p = new Intl.NumberFormat('en', { style:'currency', currency:code }).formatToParts(0);
        const cur = p.find(x=>x.type==='currency');
        return cur ? cur.value : code;
      }catch{ return code; }
    }

    function formatMarketName(code){
      if(!code) return '';
      const key = String(code).toLowerCase();
      if(customLabelMap.has(key)) return customLabelMap.get(key);
      if(Object.prototype.hasOwnProperty.call(MARKET_LABELS, key)) return MARKET_LABELS[key];
      return key.replace(/[_-]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function formatPriceInput(value){
      if(!Number.isFinite(value)) return '';
      return pref.lang === 'tr'
        ? value.toFixed(2).replace('.', ',')
        : value.toFixed(2);
    }

    function slugifyMarketName(label){
      return label.normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '')
        .substring(0, 40);
    }

    function loadCustomMarkets(){
      try{
        const raw = JSON.parse(localStorage.getItem(MARKET_STORAGE_KEY) || '[]');
        if(Array.isArray(raw)){
          return raw
            .map(item => {
              if(typeof item === 'string'){
                return { code: slugifyMarketName(item), label: item };
              }
              if(item && typeof item === 'object'){
                const code = slugifyMarketName(item.code || item.label || '');
                const label = (item.label || item.code || '').toString().trim();
                if(!code || !label) return null;
                return { code, label };
              }
              return null;
            })
            .filter(Boolean);
        }
      }catch(err){}
      return [];
    }

    function saveCustomMarkets(){
      try{
        localStorage.setItem(MARKET_STORAGE_KEY, JSON.stringify(customMarkets));
      }catch(err){}
    }

    function rebuildCustomLabelMap(){
      customLabelMap = new Map();
      customMarkets.forEach(item => {
        if(!item || !item.code) return;
        const code = String(item.code).toLowerCase();
        const label = (item.label || '').trim();
        if(code && label) customLabelMap.set(code, label);
      });
    }

    function ensureMarketInList(code){
      if(!code) return;
      if(!markets.includes(code)) markets.push(code);
    }


    function refreshSuggestionMessage(){
      if(!suggestionsEl || suggestionState === 'hidden') return;
      const strings = I18N[pref.lang].suggestions;
      let message = '';
      switch(suggestionState){
        case 'hint': message = strings.hint; break;
        case 'loading': message = strings.searching; break;
        case 'empty': message = strings.empty; break;
        case 'error': message = strings.error; break;
        case 'results': message = strings.manual; break;
        default: message = '';
      }
      suggestionMessage.textContent = message;
    }

    // ================= State & Storage =================
    const storeKey = 'smart-basket-v1';                 // keep existing data key
    const prefKey  = 'smart-basket-pref';               // language preference
    let items = JSON.parse(localStorage.getItem(storeKey) || '[]');
    const prefDefaults = { lang: 'tr', market: '' };
    let pref = Object.assign({}, prefDefaults);
    try {
      const savedPref = JSON.parse(localStorage.getItem(prefKey) || '{}');
      if (savedPref && typeof savedPref === 'object') {
        pref = Object.assign({}, prefDefaults, savedPref);
      }
    } catch (err) {
      pref = Object.assign({}, prefDefaults);
    }

    // ================= Elements =================
    const nameEl   = document.getElementById('name');
    const priceEl  = document.getElementById('price');
    const marketSelect = document.getElementById('marketSelect');
    const marketStatus = document.getElementById('marketStatus');
    const marketAddToggle = document.getElementById('marketAddToggle');
    const marketAddForm = document.getElementById('marketAddForm');
    const marketAddName = document.getElementById('marketAddName');
    const marketAddSave = document.getElementById('marketAddSave');
    const marketAddCancel = document.getElementById('marketAddCancel');
    const marketAddFeedback = document.getElementById('marketAddFeedback');
    const customMarketsWrap = document.getElementById('customMarketsWrap');
    const customMarketsTitle = document.getElementById('customMarketsTitle');
    const customMarketsEl = document.getElementById('customMarkets');
    const productSection = document.getElementById('productSection');
    const marketProductsCard = document.getElementById('marketProductsCard');
    const marketProductsTitle = document.getElementById('marketProductsTitle');
    const marketProductsSubtitle = document.getElementById('marketProductsSubtitle');
    const marketProductsInput = document.getElementById('marketProductsInput');
    const marketProductsSearch = document.getElementById('marketProductsSearch');
    const marketProductsViewAll = document.getElementById('marketProductsViewAll');
    const marketProductsRefresh = document.getElementById('marketProductsRefresh');
    const marketProductsStatus = document.getElementById('marketProductsStatus');
    const marketProductsList = document.getElementById('marketProductsList');
    const suggestionsEl = document.getElementById('suggestions');
    const suggestionMessage = document.getElementById('suggestionMessage');
    const suggestionList = document.getElementById('suggestionList');
    const addBtn   = document.getElementById('addBtn');
    const itemsEl  = document.getElementById('items');
    const countEl  = document.getElementById('count');
    const totalEl  = document.getElementById('total');
    const totalBox = document.getElementById('totalBox');
    const toastEl  = document.getElementById('toast');
    const emptyState = document.getElementById('emptyState');
    const emptyText  = document.getElementById('emptyText');
    const clearAllBtn= document.getElementById('clearAll');

    const labelMarket = document.getElementById('labelMarket');
    const labelName = document.getElementById('labelName');
    const labelPrice= document.getElementById('labelPrice');
    const btnAddText= document.getElementById('btnAddText');
    let markets = [];
    let marketLoading = true;
    let marketError = false;
    let selectedMarket = typeof pref.market === 'string' ? pref.market : '';
    let customMarkets = loadCustomMarkets();
    let customLabelMap = new Map();
    let marketProducts = [];
    let marketProductsLoading = false;
    let marketProductsError = null;
    let lastProductQuery = '';
    let productCache = new Map();
    let marketProductLookup = new Map();
    let recentlyAddedProducts = new Set();
    let suggestionRequestId = 0;
    let suggestionController = null;
    let suggestionDebounce = null;
    let suggestionState = 'hidden';
    let activeSuggestion = null;
    let lastSearchTerm = '';
    let currentPage = 1;
    let totalPages = 1;

    rebuildCustomLabelMap();

    const totalLabel= document.getElementById('totalLabel');
    const appName   = document.getElementById('appName');
    const heroSub   = document.getElementById('heroSub');
    const langBtn   = document.getElementById('langBtn');
    const flagIcon  = document.getElementById('flagIcon');

    // Edit modal elements
    const editModal = document.getElementById('editModal');
    const editModalTitle = document.getElementById('editModalTitle');
    const editName = document.getElementById('editName');
    const editPrice = document.getElementById('editPrice');
    const editLabelName = document.getElementById('editLabelName');
    const editLabelPrice = document.getElementById('editLabelPrice');
    const editSaveBtn = document.getElementById('editSaveBtn');
    const editCancelBtn = document.getElementById('editCancelBtn');
    const editModalClose = document.getElementById('editModalClose');
    let editingIndex = null;

    // ================= Formatting =================
    function makeFormatter(){
      const lang = pref.lang;
      return new Intl.NumberFormat(LOCALE[lang], { style:'currency', currency: CURRENCY[lang], minimumFractionDigits:2 });
    }
    let fmt = makeFormatter();

    function parsePriceRaw(v){
      // tolerant parser regardless of locale
      if(typeof v !== 'string') return NaN;
      v = v.trim();
      // remove currency symbols and spaces
      v = v.replace(/[\s₺$]/g,'');
      // try TR style first (1.234,56)
      let tr = v.replace(/\./g,'').replace(/,/g,'.');
      let n = parseFloat(tr);
      if(Number.isFinite(n)) return n;
      // try EN style (1,234.56)
      let en = v.replace(/,/g,'');
      n = parseFloat(en);
      return Number.isFinite(n) ? n : NaN;
    }

    // ================= Render =================
    function render(){
      const lang = pref.lang;
      const t = I18N[lang];
      document.documentElement.lang = lang;
      document.title = t.appTitle;

      // header & form texts
      appName.textContent = t.appName;
      heroSub.textContent = t.hero;

      labelName.textContent = t.labels.name;
      labelPrice.textContent = `${t.labels.price} (${currencySymbol(CURRENCY[lang])})`;
      nameEl.placeholder = t.labels.namePh;
      priceEl.placeholder = t.labels.pricePh;
      if (marketAddToggle) marketAddToggle.textContent = t.market.addToggle;
      if (marketAddToggle) marketAddToggle.title = t.market.addToggle;
      if (marketAddName) marketAddName.placeholder = t.market.addPlaceholder;
      if (marketAddSave) marketAddSave.textContent = t.market.addSave;
      if (marketAddCancel) marketAddCancel.textContent = t.market.addCancel;
      if (labelMarket) {
        labelMarket.textContent = t.labels.market;
      }
      if (marketSelect) {
        const firstOption = marketSelect.options[0];
        if (firstOption) firstOption.textContent = t.market.anyOption;
        marketSelect.title = t.labels.marketPh;
        marketSelect.setAttribute('aria-label', t.labels.market);
        populateMarketOptions();
      }
      if (marketProductsTitle) marketProductsTitle.textContent = t.products.title;
      if (marketProductsSubtitle){
        const prettyName = selectedMarket ? formatMarketName(selectedMarket) : '';
        marketProductsSubtitle.textContent = selectedMarket
          ? t.products.subtitleSelected(prettyName)
          : t.products.subtitle;
      }
      if (marketProductsInput){
        if(document.activeElement !== marketProductsInput){
          marketProductsInput.value = lastProductQuery;
        }
        marketProductsInput.placeholder = t.products.searchPlaceholder;
      }
      if (marketProductsSearch) marketProductsSearch.textContent = t.products.searchButton;
      if (marketProductsRefresh){
        marketProductsRefresh.textContent = t.products.refresh;
        marketProductsRefresh.disabled = marketProductsLoading || !selectedMarket || !lastProductQuery;
      }
      btnAddText.textContent = t.add;

      // footer
      totalLabel.textContent = t.total;
      clearAllBtn.textContent = t.clear;
      clearAllBtn.title = t.clear;

      // empty
      emptyText.innerHTML = t.empty;

      renderCustomMarkets();
      renderMarketProducts();
      renderPagination();
      updateMarketStatus();
      refreshSuggestionMessage();

      // items
      itemsEl.innerHTML = '';
      emptyState.style.display = items.length === 0 ? 'block' : 'none';

      let sum = 0;
      items.forEach((it, idx) => {
        sum += it.price;
        const metaParts = [];
        if(it.market){
          const marketName = formatMarketName(it.market);
          if(marketName) metaParts.push(marketName);
        }
        metaParts.push(new Date(it.ts).toLocaleString(LOCALE[lang]));
        const meta = escapeHtml(metaParts.join(' · '));
        const row = document.createElement('div');
        row.className = 'item' + (it.done ? ' done' : '');
        row.innerHTML = `
          <button class="btn btn-ghost" aria-label="${t.tick}" data-act="toggle" data-idx="${idx}" title="✓">✓</button>
          <div>
            <div style="font-weight:700">${escapeHtml(it.name)}</div>
            <div class="muted" style="font-size:12px">${meta}</div>
          </div>
          <span class="pill money">${fmt.format(it.price)}</span>
          <button class="btn btn-ghost" aria-label="${t.edit}" data-act="edit" data-idx="${idx}" title="✏️">✏️</button>
          <button class="btn btn-ghost" aria-label="${t.del}" data-act="del" data-idx="${idx}" title="🗑">🗑️</button>
        `;
        row.style.willChange = 'transform, opacity';
        itemsEl.appendChild(row);
      });

      countEl.textContent = I18N[lang].count(items.length);
      totalEl.textContent = fmt.format(sum);

      localStorage.setItem(storeKey, JSON.stringify(items));
      localStorage.setItem(prefKey, JSON.stringify(pref));
    }

    function renderCustomMarkets(){
      if(!customMarketsEl || !customMarketsTitle) return;
      const strings = I18N[pref.lang].market;
      customMarketsTitle.textContent = strings.customTitle;
      customMarketsEl.innerHTML = '';
      if(!customMarkets.length){
        const emptyNote = document.createElement('div');
        emptyNote.className = 'muted market-feedback';
        emptyNote.textContent = strings.customEmpty;
        customMarketsEl.appendChild(emptyNote);
        return;
      }
      customMarkets.forEach(item => {
        const tag = document.createElement('span');
        tag.className = 'market-tag';
        const label = escapeHtml(item.label);
        tag.innerHTML = `<span>${label}</span><button type="button" data-code="${item.code}" aria-label="${strings.removeLabel}">×</button>`;
        customMarketsEl.appendChild(tag);
      });
    }

    function renderMarketProducts(){
      if(!marketProductsStatus || !marketProductsList) return;
      const strings = I18N[pref.lang].products;
      if (marketProductsRefresh) marketProductsRefresh.disabled = marketProductsLoading || !selectedMarket || !lastProductQuery;
      if(marketProductsInput && document.activeElement !== marketProductsInput){
        marketProductsInput.value = lastProductQuery;
      }
      if(!selectedMarket){
        marketProductsStatus.textContent = strings.emptyMarket;
        marketProductsList.innerHTML = '';
        return;
      }
      if(marketProductsLoading){
        marketProductsStatus.textContent = strings.loading;
        marketProductsList.innerHTML = Array.from({ length:3 })
          .map(()=>'<div class="market-product-item skeleton"><div class="market-product-info"><div class="market-product-title">&nbsp;</div><div class="market-product-meta">&nbsp;</div></div><div class="market-product-actions"><div class="market-product-price">&nbsp;</div><button class="btn btn-primary btn-sm" disabled>...</button></div></div>')
          .join('');
        return;
      }
      if(!lastProductQuery){
        marketProductsStatus.textContent = strings.emptyQuery;
        marketProductsList.innerHTML = '';
        return;
      }
      if(marketProductsError){
        marketProductsStatus.textContent = strings.error;
        marketProductsList.innerHTML = '';
        return;
      }
      if(!marketProducts.length){
        marketProductsStatus.textContent = strings.emptyResult;
        marketProductsList.innerHTML = '';
        return;
      }
      marketProductsStatus.textContent = strings.resultHint;
      marketProductsList.innerHTML = '';
      marketProducts.forEach(product => {
        const item = document.createElement('div');
        item.className = 'market-product-item';
        const metaParts = [];
        if(product.brand) metaParts.push(product.brand);
        if(product.volume) metaParts.push(product.volume);
        if(product.depotName) metaParts.push(product.depotName);
        const meta = metaParts.length ? `<div class="market-product-meta">${escapeHtml(metaParts.join(' · '))}</div>` : '';
        const disabled = recentlyAddedProducts.has(product.id);
        const btnLabel = disabled ? '✓' : strings.addButton;
        item.innerHTML = `<div class="market-product-info"><div class="market-product-title">${escapeHtml(product.title || '')}</div>${meta}</div><div class="market-product-actions"><div class="market-product-price">${fmt.format(product.price)}</div><button type="button" class="btn btn-primary btn-sm"${disabled?' disabled':''} data-product="${product.id}">${btnLabel}</button></div>`;
        marketProductsList.appendChild(item);
      });
    }

    function renderPagination() {
      const paginationEl = document.getElementById('pagination');
      if (!paginationEl) return;

      paginationEl.innerHTML = '';

      if (totalPages <= 1) return;

      const prevButton = document.createElement('button');
      prevButton.textContent = 'Geri';
      prevButton.disabled = currentPage === 1;
      prevButton.addEventListener('click', () => {
        runMarketProductsSearch(lastProductQuery, currentPage - 1);
      });
      paginationEl.appendChild(prevButton);

      // Always show the first page
      if (currentPage > 2) {
        const firstButton = document.createElement('button');
        firstButton.textContent = 1;
        firstButton.addEventListener('click', () => {
          runMarketProductsSearch(lastProductQuery, 1);
        });
        paginationEl.appendChild(firstButton);
        if (currentPage > 3) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            paginationEl.appendChild(ellipsis);
        }
      }

      // Show current page, and one page before and after
      for (let i = Math.max(1, currentPage - 1); i <= Math.min(totalPages, currentPage + 1); i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        if (i === currentPage) {
          pageButton.classList.add('active');
        }
        pageButton.addEventListener('click', () => {
          runMarketProductsSearch(lastProductQuery, i);
        });
        paginationEl.appendChild(pageButton);
      }

      // Always show the last page
        if (currentPage < totalPages - 2) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            paginationEl.appendChild(ellipsis);
        }
      if (currentPage < totalPages - 1) {
        const lastButton = document.createElement('button');
        lastButton.textContent = totalPages;
        lastButton.addEventListener('click', () => {
          runMarketProductsSearch(lastProductQuery, totalPages);
        });
        paginationEl.appendChild(lastButton);
      }


      const nextButton = document.createElement('button');
      nextButton.textContent = 'İleri';
      nextButton.disabled = currentPage === totalPages;
      nextButton.addEventListener('click', () => {
        runMarketProductsSearch(lastProductQuery, currentPage + 1);
      });
      paginationEl.appendChild(nextButton);
    }

    async function runMarketProductsSearch(term, page = 1){
      let query = (term || '').trim();
      if (query === '__ALL__') {
        query = 'a'; // Use a generic search term to get all products
      }
      currentPage = page;

      if(marketProductsInput && document.activeElement !== marketProductsInput){
        marketProductsInput.value = query;
      }
      lastProductQuery = query;
      if(!selectedMarket){
        marketProducts = [];
        marketProductLookup = new Map();
        marketProductsError = null;
        marketProductsLoading = false;
        totalPages = 1;
        renderMarketProducts();
        return;
      }
      if(!query){
        marketProducts = [];
        marketProductLookup = new Map();
        marketProductsError = null;
        marketProductsLoading = false;
        totalPages = 1;
        renderMarketProducts();
        return;
      }
      const normalizedMarket = selectedMarket.toLowerCase();
      const cacheKey = `${normalizedMarket}|${query}|${page}`;
      const cached = productCache.get(cacheKey);
      if(cached && Date.now() - cached.ts < 1000*60*15){
        marketProducts = cached.items.slice(0,20);
        marketProductLookup = new Map(marketProducts.map(item => [item.id, item]));
        totalPages = cached.totalPages;
        marketProductsError = null;
        marketProductsLoading = false;
        renderMarketProducts();
        return;
      }
      marketProductsLoading = true;
      marketProductsError = null;
      renderMarketProducts();
      try{
        const payload = { keywords: query, page: page - 1, size: 20 };
        const res = await fetch(`${API.V2}/search`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('market products failed');
        const data = await res.json();
        if(query !== lastProductQuery || normalizedMarket !== selectedMarket.toLowerCase()){
          return;
        }
        totalPages = data.totalPages || 1;
        const results = [];
        (data.content || []).forEach(product => {
          (product.productDepotInfoList || []).forEach(depot => {
            const marketCode = (depot?.marketAdi || '').toLowerCase();
            if(marketCode !== normalizedMarket) return;
            if(typeof depot.price !== 'number') return;
            const id = `${product.id || Math.random().toString(36).slice(2)}-${depot.depotId || marketCode}-${Math.round(depot.price*100)}`;
            results.push({
              id,
              title: product.title || '',
              brand: product.brand || '',
              volume: product.refinedVolumeOrWeight || '',
              depotName: depot.depotName || '',
              price: depot.price,
              market: marketCode
            });
          });
        });
        results.sort((a,b)=>a.price-b.price);
        marketProducts = results;
        marketProductLookup = new Map(marketProducts.map(item => [item.id, item]));
        productCache.set(cacheKey, { items: marketProducts.slice(), totalPages, ts: Date.now() });
        marketProductsError = null;
        recentlyAddedProducts = new Set([...recentlyAddedProducts].filter(id => marketProductLookup.has(id)));
      }catch(err){
        if(query !== lastProductQuery) return;
        marketProducts = [];
        marketProductLookup = new Map();
        totalPages = 1;
        marketProductsError = err;
        recentlyAddedProducts = new Set([...recentlyAddedProducts].filter(id => marketProductLookup.has(id)));
      }finally{
        if(query === lastProductQuery){
          marketProductsLoading = false;
          renderMarketProducts();
        }
      }
    }

    function addProductToBasket(productOrId, button){
      const strings = I18N[pref.lang].products;
      const product = typeof productOrId === 'string'
        ? marketProductLookup.get(productOrId)
        : productOrId;
      if(!product) return;
      const price = Number(product.price) || 0;
      const item = {
        name: product.title || strings.fallbackName || 'Market ürünü',
        price,
        done:false,
        ts: Date.now(),
        market: selectedMarket || product.market || ''
      };
      items.unshift(item);
      if(product.id) recentlyAddedProducts.add(product.id);
      render();
      toast(strings.added);
      bump(totalBox); bump(countEl);
      if(button){
        button.disabled = true;
        button.textContent = '✓';
      }
    }

    function setMarketFeedback(message){
      if(!marketAddFeedback) return;
      marketAddFeedback.textContent = message || '';
    }

    function openMarketForm(){
      if(!marketAddForm) return;
      marketAddForm.hidden = false;
      setMarketFeedback('');
      if(marketAddName){
        marketAddName.value = '';
        marketAddName.focus();
      }
    }

    function closeMarketForm(){
      if(!marketAddForm) return;
      marketAddForm.hidden = true;
      setMarketFeedback('');
      if(marketAddName) marketAddName.value = '';
    }

    function handleCustomMarketSave(){
      if(!marketAddName) return;
      const raw = marketAddName.value || '';
      const label = raw.trim();
      const t = I18N[pref.lang].market;
      if(!label){
        setMarketFeedback(t.addPlaceholder);
        marketAddName.focus();
        return;
      }
      const code = slugifyMarketName(label);
      if(!code){
        setMarketFeedback(t.addPlaceholder);
        marketAddName.focus();
        return;
      }
      const existing = new Set([...FALLBACK_MARKETS, ...markets, ...customMarkets.map(m => m.code)]);
      if(existing.has(code)){
        setMarketFeedback(t.duplicate);
        marketAddName.focus();
        marketAddName.select();
        return;
      }
      const entry = { code, label };
      customMarkets.push(entry);
      customMarkets.sort((a,b)=> a.label.localeCompare(b.label, pref.lang === 'tr' ? 'tr' : 'en', { sensitivity:'base' }));
      rebuildCustomLabelMap();
      saveCustomMarkets();
      ensureMarketInList(code);
      selectedMarket = code;
      pref.market = code;
      localStorage.setItem(prefKey, JSON.stringify(pref));
      populateMarketOptions();
      renderCustomMarkets();
      updateMarketStatus();
      if(marketSelect) marketSelect.value = code;
      closeMarketForm();
      toast(t.saved);
      setSuggestionsState('hint');
    }

    function removeCustomMarket(code){
      const idx = customMarkets.findIndex(item => item.code === code);
      if(idx === -1) return;
      customMarkets.splice(idx,1);
      rebuildCustomLabelMap();
      saveCustomMarkets();
      const idxInMarkets = markets.indexOf(code);
      if(idxInMarkets !== -1 && !FALLBACK_MARKETS.includes(code)){
        markets.splice(idxInMarkets,1);
      }
      if(selectedMarket === code){
        selectedMarket = '';
        pref.market = '';
        localStorage.setItem(prefKey, JSON.stringify(pref));
        if(marketSelect) marketSelect.value = '';
      }
      populateMarketOptions();
      renderCustomMarkets();
      updateMarketStatus();
      toast(I18N[pref.lang].market.removed);
    }
    async function initMarkets(){
      marketLoading = true;
      marketError = false;
      updateMarketStatus();
      const collected = new Set();
      const queries = ['sut','et'];
      for(const term of queries){
        try{
          const codes = await collectMarketsFromSearch(term);
          codes.forEach(code => collected.add(code));
        }catch(err){ /* ignore individual failures */ }
      }
      if(!collected.size){
        markets = FALLBACK_MARKETS.slice();
        marketError = true;
      }else{
        markets = Array.from(collected);
      }
      populateMarketOptions();
      marketLoading = false;
      updateMarketStatus();
    }

    async function collectMarketsFromSearch(term){
      const payload = { keywords: term, pages: 0, size: 40 };
      const res = await fetch(`${API.V2}/search`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('market search failed');
      const data = await res.json();
      const codes = new Set();
      (data.content || []).forEach(product => {
        (product.productDepotInfoList || []).forEach(depot => {
          if(depot && depot.marketAdi){
            codes.add(String(depot.marketAdi).toLowerCase());
          }
        });
      });
      return Array.from(codes);
    }

    function populateMarketOptions(){
      if(!marketSelect) return;
      while(marketSelect.options.length > 1){
        marketSelect.remove(1);
      }
      const pool = new Set([...FALLBACK_MARKETS, ...markets, ...customMarkets.map(m => m.code)]);
      const seen = new Set();
      const sorted = Array.from(pool).filter(Boolean).sort((a,b)=> formatMarketName(a).localeCompare(formatMarketName(b), pref.lang === 'tr' ? 'tr' : 'en', { sensitivity:'base' }));
      sorted.forEach(code => {
        if(!code || seen.has(code)) return;
        seen.add(code);
        const option = document.createElement("option");
        option.value = code;
        option.textContent = formatMarketName(code);
        marketSelect.appendChild(option);
      });
      const previousMarket = pref.market || "";
      if(selectedMarket && !seen.has(selectedMarket)){
        selectedMarket = "";
      }
      marketSelect.value = selectedMarket;
      if(previousMarket !== selectedMarket){
        pref.market = selectedMarket;
        localStorage.setItem(prefKey, JSON.stringify(pref));
      }
    }

    function updateMarketStatus(){
      if(!marketStatus) return;
      const t = I18N[pref.lang];
      if(marketLoading){
        marketStatus.textContent = t.market.loading;
        return;
      }
      if(marketError){
        marketStatus.textContent = t.market.failed;
        return;
      }
      if(selectedMarket){
        marketStatus.textContent = t.market.readySpecific(formatMarketName(selectedMarket));
      }else{
        const pool = new Set([...markets, ...customMarkets.map(m => m.code)]);
        const count = pool.size || FALLBACK_MARKETS.length;
        marketStatus.textContent = t.market.readyAny(count);
      }
    }

    function setSuggestionsState(state){
      suggestionState = state;
      if(!suggestionsEl) return;
      const strings = I18N[pref.lang].suggestions;
      if(state === 'hidden'){
        suggestionsEl.hidden = true;
        suggestionList.innerHTML = '';
        suggestionMessage.textContent = '';
        return;
      }
      suggestionsEl.hidden = false;
      suggestionList.innerHTML = '';
      if(state === 'hint'){
        suggestionMessage.textContent = strings.hint;
      }else if(state === 'loading'){
        suggestionMessage.textContent = strings.searching;
      }else if(state === 'empty'){
        suggestionMessage.textContent = strings.empty;
        appendSuggestionInfo(strings.manual);
      }else if(state === 'error'){
        suggestionMessage.textContent = strings.error;
        appendSuggestionInfo(strings.manual);
      }else{
        suggestionMessage.textContent = '';
      }
    }

    function renderSuggestions(items){
      if(!suggestionsEl) return;
      suggestionState = 'results';
      const strings = I18N[pref.lang].suggestions;
      suggestionsEl.hidden = false;
      suggestionMessage.textContent = strings.manual;
      suggestionList.innerHTML = '';
      items.forEach(item => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggestion-item';
        const marketLabel = item.market ? formatMarketName(item.market) : I18N[pref.lang].market.anyOption;
        btn.innerHTML = `<strong>${escapeHtml(item.title || '')}</strong><div class="suggestion-meta">${escapeHtml(marketLabel)} · ${fmt.format(item.price)}</div>`;
        btn.addEventListener('click', () => applySuggestion(item));
        suggestionList.appendChild(btn);
      });
    }

    function appendSuggestionInfo(text){
      const info = document.createElement('div');
      info.className = 'suggestion-meta';
      info.textContent = text;
      suggestionList.appendChild(info);
    }

    async function loadSuggestions(term){
      lastSearchTerm = term;
      const currentId = ++suggestionRequestId;
      if(typeof AbortController !== 'undefined'){
        if(suggestionController) suggestionController.abort();
        suggestionController = new AbortController();
      }
      setSuggestionsState('loading');
      try{
        const payload = { keywords: term, pages: 0, size: 20 };
        const res = await fetch(`${API.V2}/search`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(payload),
          signal: suggestionController ? suggestionController.signal : undefined
        });
        if(!res.ok) throw new Error('search failed');
        const data = await res.json();
        if(currentId !== suggestionRequestId) return;
        let items = [];
        (data.content || []).forEach(product => {
          (product.productDepotInfoList || []).forEach(depot => {
            if(!depot || typeof depot.price !== 'number') return;
            items.push({
              id: product.id,
              title: product.title,
              price: depot.price,
              market: depot.marketAdi ? String(depot.marketAdi).toLowerCase() : ''
            });
          });
        });
        if(selectedMarket){
          items = items.filter(item => item.market === selectedMarket);
        }
        const seen = new Set();
        const top = [];
        for(const item of items){
          const key = `${item.market}|${item.title}`;
          if(seen.has(key)) continue;
          seen.add(key);
          top.push(item);
          if(top.length >= 8) break;
        }
        if(!top.length){
          setSuggestionsState('empty');
        }else{
          renderSuggestions(top);
        }
      }catch(err){
        if(err && err.name === 'AbortError') return;
        if(currentId !== suggestionRequestId) return;
        setSuggestionsState('error');
      }finally{
        if(currentId === suggestionRequestId){
          suggestionController = null;
        }
      }
    }

    function applySuggestion(item){
      if(!item) return;
      activeSuggestion = item;
      nameEl.value = item.title || '';
      priceEl.value = formatPriceInput(item.price);
      setSuggestionsState('hidden');
      nameEl.focus();
    }

    function scheduleSuggestions(term){
      if(suggestionDebounce) clearTimeout(suggestionDebounce);
      suggestionDebounce = setTimeout(() => loadSuggestions(term), 320);
    }

    function stopSuggestionFetch(){
      if(suggestionController){
        try{ suggestionController.abort(); }catch(err){}
        suggestionController = null;
      }
    }

    function onNameInput(){
      activeSuggestion = null;
      const term = (nameEl.value || '').trim();
      if(term.length < 2){
        lastSearchTerm = term;
        stopSuggestionFetch();
        if(term.length === 0){
          setSuggestionsState('hidden');
        }else{
          setSuggestionsState('hint');
        }
        return;
      }
      lastSearchTerm = term;
      scheduleSuggestions(term);
    }


    // ================= Toast =================
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = msg || I18N[pref.lang].added;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 1400);
    }

    // ================= Actions =================
    function addItem(){
      const t = I18N[pref.lang];
      const name = (nameEl.value || '').trim();
      const price = parsePriceRaw((priceEl.value || '').trim());
      if(!name){ nameEl.focus(); pulse(nameEl); return; }
      if(!Number.isFinite(price) || price < 0){ priceEl.focus(); pulse(priceEl); return; }

      const item = {
        name,
        price,
        done:false,
        ts: Date.now(),
        market: activeSuggestion && activeSuggestion.market
          ? activeSuggestion.market
          : (selectedMarket || '')
      };
      items.unshift(item);
      nameEl.value = ''; priceEl.value = '';
      stopSuggestionFetch();
      activeSuggestion = null;
      lastSearchTerm = '';
      setSuggestionsState('hidden');
      nameEl.focus();
      render();

      // micro animations
      toast(t.added);
      bump(totalBox); bump(countEl); bump(addBtn);
    }

    function editItem(idx){
      editingIndex = idx;
      const item = items[idx];
      const t = I18N[pref.lang];

      editModalTitle.textContent = t.editTitle;
      editLabelName.textContent = t.labels.name;
      editLabelPrice.textContent = `${t.labels.price} (${currencySymbol(CURRENCY[pref.lang])})`;
      editSaveBtn.textContent = t.save;
      editCancelBtn.textContent = t.cancel;

      editName.value = item.name;
      // format price for editing
      editPrice.value = pref.lang === 'tr' 
        ? item.price.toFixed(2).replace('.', ',')
        : item.price.toFixed(2);

      editModal.classList.add('show');
      setTimeout(() => editName.focus(), 100);
    }

    function saveEdit(){
      if(editingIndex === null) return;
      const name = (editName.value || '').trim();
      const price = parsePriceRaw((editPrice.value || '').trim());
      
      if(!name){ editName.focus(); pulse(editName); return; }
      if(!Number.isFinite(price) || price < 0){ editPrice.focus(); pulse(editPrice); return; }

      items[editingIndex].name = name;
      items[editingIndex].price = price;
      closeEditModal();
      render();
      bump(totalBox); bump(countEl);
    }

    function closeEditModal(){
      editModal.classList.remove('show');
      editingIndex = null;
      editName.value = '';
      editPrice.value = '';
    }

    function bump(el){ el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump'); }

    function pulse(el){ el.style.boxShadow = '0 0 0 6px #ef444455'; setTimeout(()=> el.style.boxShadow = '', 250); }

    document.addEventListener('click', (e)=>{
      if(!suggestionsEl || suggestionsEl.hidden) return;
      if(e.target === nameEl) return;
      if(suggestionsEl.contains(e.target)) return;
      stopSuggestionFetch();
      setSuggestionsState('hidden');
    });

    // generic ripple on all buttons
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const r = document.createElement('span');
      r.className = 'ripple';
      const rect = btn.getBoundingClientRect();
      r.style.left = (e.clientX - rect.left) + 'px';
      r.style.top  = (e.clientY - rect.top)  + 'px';
      btn.appendChild(r);
      setTimeout(()=>r.remove(), 650);
    }, { passive:true });

    // list actions
    itemsEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const idx = +btn.dataset.idx; const act = btn.dataset.act; if(Number.isNaN(idx)) return;
      if(act === 'del'){ items.splice(idx,1); render(); bump(totalBox); bump(countEl); }
      else if(act === 'toggle'){ items[idx].done = !items[idx].done; render(); }
      else if(act === 'edit'){ editItem(idx); }
    });

    addBtn.addEventListener('click', addItem);
    nameEl.addEventListener('input', onNameInput);
    nameEl.addEventListener('focus', ()=>{ if(!(nameEl.value||'').trim()) setSuggestionsState('hint'); });
    nameEl.addEventListener('blur', ()=>{ setTimeout(()=>{ if(!suggestionsEl) return; const active=document.activeElement; if(active && (active===nameEl || suggestionsEl.contains(active))) return; setSuggestionsState('hidden'); }, 150); });
    nameEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') priceEl.focus(); });
    priceEl.addEventListener('input', ()=>{ activeSuggestion = null; });
    priceEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') addItem(); });

    if(marketSelect){
      marketSelect.addEventListener('change', ()=>{
        selectedMarket = marketSelect.value;
        pref.market = selectedMarket;
        stopSuggestionFetch();
        recentlyAddedProducts.clear();
        render();
        if(lastSearchTerm && lastSearchTerm.trim().length >= 2){
          loadSuggestions(lastSearchTerm.trim());
        }else if(!lastSearchTerm){
          setSuggestionsState('hidden');
        }else{
          setSuggestionsState('hint');
        }
        if(lastProductQuery){
          runMarketProductsSearch(lastProductQuery);
        }else{
          marketProducts = [];
          marketProductLookup = new Map();
          marketProductsError = null;
          marketProductsLoading = false;
          renderMarketProducts();
        }
      });
    }

    if(marketAddToggle){
      marketAddToggle.addEventListener('click', ()=>{
        if(marketAddForm && !marketAddForm.hidden){ closeMarketForm(); }
        else{ openMarketForm(); }
      });
    }
    if(marketAddCancel){ marketAddCancel.addEventListener('click', closeMarketForm); }
    if(marketAddSave){ marketAddSave.addEventListener('click', handleCustomMarketSave); }
    if(marketAddName){
      marketAddName.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          handleCustomMarketSave();
        }else if(e.key === 'Escape'){
          closeMarketForm();
        }
      });
    }
    if(customMarketsEl){
      customMarketsEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-code]');
        if(!btn) return;
        removeCustomMarket(btn.dataset.code);
      });
    }

    clearAllBtn.addEventListener('click', ()=>{
      if(items.length===0) return;
      if(confirm(I18N[pref.lang].confirmClear)){ items = []; render(); }
    });

    // Edit modal events
    editSaveBtn.addEventListener('click', saveEdit);
    editCancelBtn.addEventListener('click', closeEditModal);
    editModalClose.addEventListener('click', closeEditModal);
    editModal.addEventListener('click', (e)=>{
      if(e.target === editModal) closeEditModal();
    });
    editName.addEventListener('keydown', (e)=>{ if(e.key==='Enter') editPrice.focus(); });
    editPrice.addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveEdit(); if(e.key==='Escape') closeEditModal(); });

    if (marketProductsSearch) {
      marketProductsSearch.addEventListener('click', () => {
        const term = (marketProductsInput?.value || '').trim();
        lastProductQuery = term;
        runMarketProductsSearch(term);
      });
    }

    if (marketProductsViewAll) {
      marketProductsViewAll.addEventListener('click', () => {
        lastProductQuery = '__ALL__';
        runMarketProductsSearch(lastProductQuery);
      });
    }

    if (marketProductsRefresh) {
      marketProductsRefresh.addEventListener('click', () => {
        if(selectedMarket && lastProductQuery){
          runMarketProductsSearch(lastProductQuery);
        }else if(selectedMarket && marketProductsInput){
          runMarketProductsSearch(marketProductsInput.value);
        }else{
          renderMarketProducts();
        }
      });
    }

    if (marketProductsInput) {
      marketProductsInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const term = (marketProductsInput.value || '').trim();
          lastProductQuery = term;
          runMarketProductsSearch(term);
        }
      });
    }

    if (marketProductsList) {
      marketProductsList.addEventListener('click', (e) => {
        const button = e.target.closest('[data-product]');
        if (!button) return;
        const product = marketProductLookup.get(button.dataset.product);
        if (!product) return;
        addProductToBasket(product, button);
      });
    }

    // ================= Language toggle (TR <-> EN) =================
    function setFlag(lang){
      const isTR = lang==='tr';
      // swap inline SVG flag
      flagIcon.innerHTML = isTR
        ? `
          <g fill-rule="evenodd" stroke-width="1pt">
            <path fill="#e30a17" d="M0 0h640v480H0z"/>
            <path fill="#fff" d="M406 240c0 66.274-53.726 120-120 120S166 306.274 166 240s53.726-120 120-120 120 53.726 120 120z"/>
            <path fill="#e30a17" d="M413 240c0 52.467-42.533 95-95 95s-95-42.533-95-95 42.533-95 95-95 95 42.533 95 95z"/>
            <path fill="#fff" d="m421 240-60.78 19.021 37.6-51.733v65.424l-37.6-51.733z"/>
          </g>`
        : `
          <g fill-rule="evenodd" stroke-width="1pt">
            <path fill="#b22234" d="M0 0h741v390H0z"/>
            <path fill="#fff" d="M0 45h741v30H0zm0 60h741v30H0zm0 60h741v30H0zm0 60h741v30H0zm0 60h741v30H0zm0 60h741v30H0z"/>
            <path fill="#3c3b6e" d="M0 0h296v210H0z"/>
            <!-- stars simplified for brevity -->
            <g fill="#fff" transform="scale(0.8)">
              <circle cx="30" cy="20" r="4"/><circle cx="60" cy="35" r="4"/><circle cx="90" cy="20" r="4"/>
              <circle cx="120" cy="35" r="4"/><circle cx="150" cy="20" r="4"/><circle cx="180" cy="35" r="4"/>
              <circle cx="210" cy="20" r="4"/><circle cx="240" cy="35" r="4"/>
            </g>
          </g>`;
    }

    langBtn.addEventListener('click', ()=>{
      pref.lang = pref.lang === 'tr' ? 'en' : 'tr';
      setFlag(pref.lang);
      fmt = makeFormatter();
      render();
      // subtle feedback
      bump(langBtn);
    });

    // ================= Utilities =================
    function escapeHtml(s){ return s.replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[c])); }

    // ================= Init =================
    setFlag(pref.lang);
    render();
    initMarkets();

    // PWA: Service Worker kaydı (GitHub Pages için göreli yol)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>


















